<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Will you be my Valentine?</title>

    <!-- Confetti library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg1: #ffd6e7;
            --bg2: #ffeef6;
            --card: #ffffffcc;
            --yes: #ff3b7a;
            --yesHover: #ff1f68;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100svh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: radial-gradient(circle at top, var(--bg2), var(--bg1));
            font-family: system-ui, sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            padding: clamp(0.75rem, 3vw, 1.5rem);
        }

        /* FULL-SCREEN CONFETTI CANVAS */
        #confettiCanvas {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
        }

        .card {
            width: min(48rem, 96vw);
            padding: clamp(1rem, 3vw, 1.75rem);
            background: var(--card);
            backdrop-filter: blur(10px);
            border-radius: clamp(1rem, 2vw, 1.375rem);
            text-align: center;
            box-shadow: 0 18px 60px rgba(0, 0, 0, .15);
            margin: clamp(0.5rem, 2vw, 1rem) 0 clamp(1rem, 4vw, 2rem);
        }

        .art {
            width: clamp(8rem, 40vw, 16rem);
            margin: 0 auto clamp(0.5rem, 2vw, 0.75rem);
            display: block;
            filter: drop-shadow(0 10px 14px rgba(0, 0, 0, .12));
        }

        h1 {
            font-size: clamp(1.4rem, 4vw, 2.75rem);
            margin: clamp(0.5rem, 2vw, 0.75rem) 0 clamp(0.75rem, 2.5vw, 1.125rem);
        }

        .button-zone {
            position: relative;
            width: min(32rem, 94%);
            height: clamp(7.5rem, 20vw, 10rem);
            margin: 0 auto;
            touch-action: none;
        }

        button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            padding: clamp(0.75rem, 2.8vw, 1rem) clamp(1rem, 3vw, 1.5rem);
            font-size: clamp(0.95rem, 2.2vw, 1.125rem);
            font-weight: 800;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 24px rgba(0, 0, 0, .14);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: transform .12s ease, background .12s ease;
            min-height: 2.75rem;
            min-width: 2.75rem;
        }

        #yesBtn {
            left: 18%;
            background: var(--yes);
            color: #fff;
        }

        @media (hover: hover) and (pointer: fine) {
            #yesBtn:hover {
                background: var(--yesHover);
            }
        }

        #noBtn {
            left: 62%;
            background: #e5e7eb;
            color: #111827;
        }

        .hint {
            margin-top: clamp(0.5rem, 1.5vw, 0.75rem);
            font-size: clamp(0.75rem, 2vw, 0.8125rem);
            opacity: .7;
        }

        .result {
            display: none;
            margin-top: clamp(0.75rem, 2.5vw, 1.125rem);
            animation: pop .35s ease;
        }

        .result h2 {
            font-size: clamp(1.6rem, 4.5vw, 2.875rem);
            margin: clamp(0.5rem, 1.8vw, 0.75rem) 0;
        }

        .fireworks {
            width: clamp(10rem, 52vw, 18rem);
            margin: 0 auto;
            display: block;
            opacity: 0.8;
            filter: saturate(0.9);
        }

        .love-card {
            margin: 0.75rem auto 0;
            width: min(22rem, 92vw);
            aspect-ratio: 5 / 7;
            background: linear-gradient(165deg, #fff9fc 0%, #ffeaf3 52%, #ffe2ee 100%);
            border: 1px solid #ffc7dc;
            border-radius: 1.15rem;
            padding: clamp(0.85rem, 2.8vw, 1.15rem);
            box-shadow: 0 16px 34px rgba(110, 20, 58, .14);
            display: grid;
            align-content: space-between;
            justify-items: center;
            overflow: hidden;
            position: relative;
            isolation: isolate;
            animation: cardGlow 4.8s ease-in-out infinite;
        }

        .love-card::before {
            content: "";
            position: absolute;
            inset: -25%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0) 62%);
            transform: translateY(-12%);
            z-index: -1;
        }

        .love-card .rose {
            width: clamp(7.5rem, 42vw, 11.5rem);
            display: block;
            margin: 0.1rem auto 0.4rem;
            filter: drop-shadow(0 10px 16px rgba(135, 15, 60, .2));
            opacity: 0.92;
            animation: roseFloat 3.6s ease-in-out infinite;
        }

        .love-card .love-title {
            margin: 0.1rem 0 0.25rem;
            font-family: "STXingkai", "Xingkai SC", "Kaiti SC", cursive;
            font-size: clamp(1.6rem, 5.2vw, 2.05rem);
            font-weight: 700;
            line-height: 1.15;
            text-align: center;
            color: #9f1749;
            letter-spacing: 0.02em;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7), 0 8px 20px rgba(159, 23, 73, 0.18);
        }

        .love-card .love-text {
            width: 100%;
            min-height: 3.2rem;
            display: grid;
            place-items: center;
            font-size: clamp(1.1rem, 3.4vw, 1.35rem);
            font-weight: 900;
            line-height: 1.5;
            text-align: center;
            word-break: break-word;
            color: #ad1048;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.88), rgba(255, 250, 253, 0.82));
            border: 1px solid #ffd0e1;
            border-radius: 0.85rem;
            padding: 0.62rem 0.85rem;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.65);
        }

        .snake {
            margin-top: clamp(0.75rem, 2.5vw, 1.125rem);
            padding: clamp(0.75rem, 2.5vw, 1rem);
            border-radius: clamp(0.75rem, 2vw, 1rem);
            background: #ffffffb0;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .04);
        }

        .snake .meta {
            display: flex;
            justify-content: center;
            gap: clamp(0.5rem, 2vw, 0.875rem);
            font-size: clamp(0.75rem, 2vw, 0.8125rem);
            opacity: .75;
            margin-bottom: clamp(0.5rem, 1.5vw, 0.75rem);
            flex-wrap: wrap;
        }

        .snake .layout {
            display: grid;
            gap: clamp(0.75rem, 2.5vw, 1rem);
            align-items: start;
        }

        @media (min-width: 40rem) {
            .snake .layout {
                grid-template-columns: minmax(0, 1fr) minmax(10rem, 14rem);
            }
        }

        .snake .board {
            width: clamp(14rem, 70vw, 22rem);
            aspect-ratio: 1 / 1;
            background: #fff;
            border-radius: clamp(0.5rem, 1.5vw, 0.75rem);
            margin: 0 auto;
            display: grid;
            place-items: center;
            box-shadow: 0 10px 24px rgba(0, 0, 0, .08);
        }

        #snakeCanvas {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        .snake .side {
            display: grid;
            gap: clamp(0.5rem, 2vw, 0.75rem);
            justify-items: center;
        }

        .snake .keys {
            width: 100%;
            background: #ffffffcc;
            border-radius: clamp(0.5rem, 1.5vw, 0.75rem);
            padding: clamp(0.5rem, 1.5vw, 0.625rem);
            font-size: clamp(0.75rem, 2vw, 0.8125rem);
            text-align: center;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .04);
        }

        .snake .stats {
            width: 100%;
            background: #ffffffcc;
            border-radius: clamp(0.5rem, 1.5vw, 0.75rem);
            padding: clamp(0.5rem, 1.5vw, 0.625rem);
            font-size: clamp(0.75rem, 2vw, 0.8125rem);
            text-align: left;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .04);
        }

        .snake .title-card {
            width: 100%;
            background: #ffffffcc;
            border-radius: clamp(0.5rem, 1.5vw, 0.75rem);
            padding: clamp(0.5rem, 1.5vw, 0.625rem);
            text-align: center;
            font-weight: 800;
            font-size: clamp(0.9rem, 2.2vw, 1rem);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .04);
        }

        .snake .stats .title {
            font-weight: 800;
            margin-bottom: 6px;
            text-align: center;
        }

        .snake .stats .row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin: 4px 0;
        }

        .snake .keys .title {
            font-weight: 800;
            margin-bottom: 6px;
        }

        .snake .key-row {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 4px 0;
            flex-wrap: wrap;
        }

        .snake .keycap {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 0.25rem 0.5rem;
            font-weight: 700;
            font-size: clamp(0.7rem, 1.8vw, 0.75rem);
        }

        .snake .controls {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(0.5rem, 2vw, 0.75rem);
            width: min(14rem, 70vw);
            margin: 0 auto;
        }

        .snake .controls button {
            position: static;
            transform: none;
            padding: 0.75rem 0;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            font-weight: 700;
            border-radius: clamp(0.5rem, 1.5vw, 0.75rem);
            background: #f3f4f6;
            color: #111827;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .08);
            min-height: 2.75rem;
        }

        @media (pointer: coarse) {
            .snake .controls {
                display: grid;
            }
        }

        .snake .actions {
            display: flex;
            justify-content: center;
            gap: clamp(0.5rem, 2vw, 0.75rem);
            margin-top: clamp(0.5rem, 1.5vw, 0.75rem);
            flex-wrap: wrap;
        }

        .snake .actions button {
            position: static;
            transform: none;
            padding: 0.65rem 1rem;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            font-weight: 800;
            border-radius: 999px;
            background: #111827;
            color: #fff;
            min-height: 2.75rem;
        }

        .snake .actions button.secondary {
            background: #e5e7eb;
            color: #111827;
        }

        .snake .status {
            margin-top: clamp(0.35rem, 1.2vw, 0.5rem);
            font-size: clamp(0.75rem, 2vw, 0.8125rem);
            opacity: .75;
        }

        @media (min-width: 64rem) {
            .card {
                width: min(56rem, 94vw);
            }

            .snake .layout {
                grid-template-columns: minmax(0, 1fr) minmax(12rem, 16rem);
            }
        }

        @keyframes pop {
            from {
                transform: scale(.96);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes roseFloat {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }

            100% {
                transform: translateY(0);
            }
        }

        @keyframes cardGlow {
            0% {
                box-shadow: 0 16px 34px rgba(110, 20, 58, .12);
            }

            50% {
                box-shadow: 0 18px 38px rgba(110, 20, 58, .16);
            }

            100% {
                box-shadow: 0 16px 34px rgba(110, 20, 58, .12);
            }
        }

    </style>
</head>

<body>
    <canvas id="confettiCanvas"></canvas>

    <main class="card">
        <img class="art" src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExdXBuaG5ua3lyeW1vYzhqOGhpaHdiNnhnYnl2c3ByaDcydWx0YW1jdCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Ie4CIIvQS0bk3zwZlM/giphy.gif" alt="Valentine animation" />

        <h1>Mandy will you be my valentine?</h1>

        <section class="button-zone" id="zone">
            <button id="yesBtn">Yes</button>
            <button id="noBtn">No</button>
        </section>

        <!-- HINT (ONLY FIRST SECTION) -->
        <div class="hint" id="hint">‚ÄúNo‚Äù seems a bit shy üòà</div>

        <section class="result" id="result">
            <img class="fireworks" src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExY3E5cWdvcmZhejhoYWx5Z3FtMGI0dGl4amVrcmluczRkeG82N3hteiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/IzXiddo2twMmdmU8Lv/giphy.gif" alt="Fireworks" />
            <section class="love-card" aria-label="Valentine card">
                <h2 class="love-title">Happy Valentine Day</h2>
                <img class="rose" src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExNXIyOTlqanh6ZGFpcmN0bmF5Z3Y0eXBqbnh1aTM2b25mNHRmdWt1bSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/rKXbXooKRaFWg/giphy.gif" alt="Rose animation" />
                <div id="loveText" class="love-text" aria-live="polite"></div>
            </section>
        </section>

        <section class="snake" aria-label="Snake game">
            <div class="layout">
                <div class="board">
                    <canvas id="snakeCanvas" width="360" height="360" aria-label="Snake board"></canvas>
                </div>
                <aside class="side" aria-label="Snake controls">
                    <div class="title-card">Snake</div>
                    <div class="stats">
                        <div class="title">Game</div>
                        <div class="row">
                            <span>Score</span>
                            <strong id="snakeScore">0</strong>
                        </div>
                        <div class="row">
                            <span>High</span>
                            <strong id="snakeHigh">0</strong>
                        </div>
                        <div class="row">
                            <span>Tick</span>
                            <strong id="snakeTick">0</strong>
                        </div>
                    </div>
                    <div class="keys">
                        <div class="title">Keyboard</div>
                        <div class="key-row">
                            <span class="keycap">‚Üë</span>
                            <span class="keycap">‚Üê</span>
                            <span class="keycap">‚Üì</span>
                            <span class="keycap">‚Üí</span>
                        </div>
                        <div class="key-row">
                            <span class="keycap">Space = Pause</span>
                            <span class="keycap">R = Restart</span>
                        </div>
                    </div>
                    <div class="controls" aria-hidden="true">
                        <span></span>
                        <button data-dir="up">Up</button>
                        <span></span>
                        <button data-dir="left">Left</button>
                        <button data-dir="down">Down</button>
                        <button data-dir="right">Right</button>
                    </div>
                </aside>
            </div>
            <div class="actions">
                <button id="snakePause" class="secondary">Pause</button>
                <button id="snakeRestart">Restart</button>
            </div>
            <div class="status" id="snakeStatus">Use arrow keys (or touch buttons on mobile).</div>
        </section>
    </main>

    <script>
        const zone = document.getElementById("zone");
        const yesBtn = document.getElementById("yesBtn");
        const noBtn = document.getElementById("noBtn");
        const result = document.getElementById("result");
        const hint = document.getElementById("hint");
        const titleEl = document.querySelector("h1");
        const snakeSection = document.querySelector(".snake");
        const loveTextEl = document.getElementById("loveText");

        /* ---------- CONFETTI (FIXED FULL SCREEN) ---------- */
        const confettiCanvas = document.getElementById("confettiCanvas");

        function resizeConfettiCanvas() {
            const dpr = Math.max(1, window.devicePixelRatio || 1);
            confettiCanvas.width = Math.floor(window.innerWidth * dpr);
            confettiCanvas.height = Math.floor(window.innerHeight * dpr);
            confettiCanvas.style.width = "100vw";
            confettiCanvas.style.height = "100vh";
        }

        resizeConfettiCanvas();
        window.addEventListener("resize", resizeConfettiCanvas);
        window.addEventListener("orientationchange", () => setTimeout(resizeConfettiCanvas, 150));

        const confettiInstance = confetti.create(confettiCanvas, {
            resize: false,
            useWorker: true
        });

        function fullScreenConfetti() {
            const end = Date.now() + 1600;

            (function frame() {
                confettiInstance({
                    particleCount: 12,
                    spread: 90,
                    startVelocity: 45,
                    ticks: 180,
                    origin: { x: Math.random(), y: Math.random() * 0.3 }
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            })();

            setTimeout(() => {
                confettiInstance({
                    particleCount: 300,
                    spread: 140,
                    startVelocity: 60,
                    ticks: 220,
                    origin: { x: 0.5, y: 0.55 }
                });
            }, 300);
        }

        /* ---------- YES BUTTON GROWS ---------- */
        let yesScale = 1;
        function growYes() {
            yesScale = Math.min(2.2, yesScale + 0.1);
            yesBtn.style.transform = `translateY(-50%) scale(${yesScale})`;
        }

        /* ---------- NO BUTTON RUNS AWAY ---------- */
        function clamp(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        function moveNo(px, py) {
            const z = zone.getBoundingClientRect();
            const b = noBtn.getBoundingClientRect();

            let dx = (b.left + b.width / 2) - px;
            let dy = (b.top + b.height / 2) - py;
            let mag = Math.hypot(dx, dy) || 1;
            dx /= mag;
            dy /= mag;

            let newLeft = (b.left - z.left) + dx * 150;
            let newTop = (b.top - z.top) + dy * 150;

            newLeft = clamp(newLeft, 0, z.width - b.width);
            newTop = clamp(newTop, 0, z.height - b.height);

            noBtn.style.left = newLeft + "px";
            noBtn.style.top = newTop + "px";
            noBtn.style.transform = "none";

            growYes();
        }

        zone.addEventListener("pointermove", e => {
            const b = noBtn.getBoundingClientRect();
            const d = Math.hypot(
                (b.left + b.width / 2) - e.clientX,
                (b.top + b.height / 2) - e.clientY
            );
            if (d < 140) moveNo(e.clientX, e.clientY);
        });

        noBtn.addEventListener("click", e => e.preventDefault());

        /* ---------- VALENTINE CARD ---------- */
        const LOVE_MESSAGE = "ÈÄôÊÆµÊôÇÈñìÔºåË∑üÂ¶≥‰∏ÄËµ∑Áõ∏ËôïÁöÑÊôÇÂÖâÔºåÊàë‰∏ÄÁõ¥ÈÉΩÂæàÁèçÊÉú„ÄÇ";
        const LOVE_TICK_MS = 180;
        const LOVE_HOLD_TICKS = 5;

        const LoveCardCore = (() => {
            function createInitialState() {
                return {
                    visibleChars: 0,
                    holdTicks: 0
                };
            }

            function reduce(state, action) {
                switch (action.type) {
                    case "TICK":
                        if (state.visibleChars < LOVE_MESSAGE.length) {
                            return { ...state, visibleChars: state.visibleChars + 1 };
                        }
                        if (state.holdTicks < LOVE_HOLD_TICKS) {
                            return { ...state, holdTicks: state.holdTicks + 1 };
                        }
                        return createInitialState();
                    default:
                        return state;
                }
            }

            function currentText(state) {
                return LOVE_MESSAGE.slice(0, state.visibleChars);
            }

            return { createInitialState, reduce, currentText };
        })();

        let loveState = LoveCardCore.createInitialState();
        let loveTickHandle = null;
        let loveStarted = false;

        function renderLoveCard() {
            loveTextEl.textContent = LoveCardCore.currentText(loveState);
        }

        function stepLoveCard() {
            loveState = LoveCardCore.reduce(loveState, { type: "TICK" });
            renderLoveCard();
        }

        function startLoveLoop() {
            if (loveTickHandle) clearInterval(loveTickHandle);
            loveTickHandle = setInterval(stepLoveCard, LOVE_TICK_MS);
        }

        renderLoveCard();

        /* ---------- YES CLICK ---------- */
        yesBtn.addEventListener("click", () => {
            zone.style.display = "none";
            hint.style.display = "none";     // HIDE THE HINT
            result.style.display = "block";
            if (snakeSection) snakeSection.style.display = "none";
            if (titleEl) titleEl.textContent = "I knew it üòè!";
            if (!loveStarted) {
                loveStarted = true;
                startLoveLoop();
            }
            resizeConfettiCanvas();
            fullScreenConfetti();
        });

        /* ---------- SNAKE GAME ---------- */
        const GRID_SIZE = 16;
        const TICK_MS = 140;
        const board = document.getElementById("snakeCanvas");
        const scoreEl = document.getElementById("snakeScore");
        const highEl = document.getElementById("snakeHigh");
        const tickEl = document.getElementById("snakeTick");
        const statusEl = document.getElementById("snakeStatus");
        const pauseBtn = document.getElementById("snakePause");
        const restartBtn = document.getElementById("snakeRestart");
        const controlButtons = document.querySelectorAll(".snake .controls button");
        const boardWrapper = document.querySelector(".snake .board");

        const ctx = board.getContext("2d");
        let tickHandle = null;
        let paused = false;
        let highScore = 0;

        const SnakeCore = (() => {
            function randInt(max, rng) {
                return Math.floor(rng() * max);
            }

            function spawnFood(snake, size, rng) {
                const occupied = new Set(snake.map(p => `${p.x},${p.y}`));
                const empty = [];
                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                        const key = `${x},${y}`;
                        if (!occupied.has(key)) empty.push({ x, y });
                    }
                }
                if (empty.length === 0) return null;
                return empty[randInt(empty.length, rng)];
            }

            function createInitialState(size, rng) {
                const start = { x: Math.floor(size / 2), y: Math.floor(size / 2) };
                const snake = [start, { x: start.x - 1, y: start.y }, { x: start.x - 2, y: start.y }];
                return {
                    snake,
                    dir: { x: 1, y: 0 },
                    nextDir: { x: 1, y: 0 },
                    food: spawnFood(snake, size, rng),
                    score: 0,
                    ticks: 0,
                    over: false
                };
            }

            function isReverse(a, b) {
                return a.x === -b.x && a.y === -b.y;
            }

            function step(state, size, rng) {
                if (state.over) return state;
                const dir = isReverse(state.nextDir, state.dir) ? state.dir : state.nextDir;
                const head = state.snake[0];
                const next = { x: head.x + dir.x, y: head.y + dir.y };

                if (next.x < 0 || next.x >= size || next.y < 0 || next.y >= size) {
                    return { ...state, dir, ticks: state.ticks + 1, over: true };
                }

                const hitsSelf = state.snake.some((p, idx) => idx !== 0 && p.x === next.x && p.y === next.y);
                if (hitsSelf) return { ...state, dir, ticks: state.ticks + 1, over: true };

                const ate = state.food && next.x === state.food.x && next.y === state.food.y;
                const newSnake = [next, ...state.snake];
                if (!ate) newSnake.pop();

                const newFood = ate ? spawnFood(newSnake, size, rng) : state.food;
                return {
                    ...state,
                    dir,
                    snake: newSnake,
                    food: newFood,
                    score: state.score + (ate ? 1 : 0),
                    ticks: state.ticks + 1,
                    over: newFood === null ? true : false
                };
            }

            return { createInitialState, step };
        })();

        let gameState = SnakeCore.createInitialState(GRID_SIZE, Math.random);

        function resizeBoard() {
            const size = Math.floor(boardWrapper.clientWidth || 360);
            const dpr = Math.max(1, window.devicePixelRatio || 1);
            board.width = Math.floor(size * dpr);
            board.height = Math.floor(size * dpr);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            draw();
        }

        function draw() {
            const size = boardWrapper.clientWidth || 360;
            const cell = size / GRID_SIZE;
            ctx.clearRect(0, 0, size, size);

            ctx.fillStyle = "#f8fafc";
            ctx.fillRect(0, 0, size, size);

            ctx.strokeStyle = "rgba(0,0,0,0.05)";
            for (let i = 0; i <= GRID_SIZE; i++) {
                ctx.beginPath();
                ctx.moveTo(i * cell, 0);
                ctx.lineTo(i * cell, size);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i * cell);
                ctx.lineTo(size, i * cell);
                ctx.stroke();
            }

            if (gameState.food) {
                ctx.fillStyle = "#ff3b7a";
                ctx.beginPath();
                ctx.roundRect(
                    gameState.food.x * cell + 2,
                    gameState.food.y * cell + 2,
                    cell - 4,
                    cell - 4,
                    6
                );
                ctx.fill();
            }

            ctx.fillStyle = "#111827";
            gameState.snake.forEach((p, i) => {
                const inset = i === 0 ? 1 : 3;
                ctx.beginPath();
                ctx.roundRect(
                    p.x * cell + inset,
                    p.y * cell + inset,
                    cell - inset * 2,
                    cell - inset * 2,
                    6
                );
                ctx.fill();
            });
        }

        function updateScore() {
            scoreEl.textContent = gameState.score;
            if (gameState.score > highScore) highScore = gameState.score;
            highEl.textContent = highScore;
            tickEl.textContent = gameState.ticks;
        }

        function setStatus() {
            if (gameState.over) {
                statusEl.textContent = "Game over. Press Restart.";
            } else if (paused) {
                statusEl.textContent = "Paused. Press Pause or Space to resume.";
            } else {
                statusEl.textContent = "Use keyboard controls on the right (or touch buttons on mobile).";
            }
        }

        function tick() {
            if (paused || gameState.over) return;
            gameState = SnakeCore.step(gameState, GRID_SIZE, Math.random);
            updateScore();
            draw();
            setStatus();
        }

        function startLoop() {
            if (tickHandle) clearInterval(tickHandle);
            tickHandle = setInterval(tick, TICK_MS);
        }

        function restart() {
            gameState = SnakeCore.createInitialState(GRID_SIZE, Math.random);
            paused = false;
            updateScore();
            draw();
            setStatus();
        }

        function setDirection(dir) {
            gameState = { ...gameState, nextDir: dir };
        }

        const directionMap = {
            ArrowUp: { x: 0, y: -1 },
            ArrowDown: { x: 0, y: 1 },
            ArrowLeft: { x: -1, y: 0 },
            ArrowRight: { x: 1, y: 0 }
        };

        window.addEventListener("keydown", e => {
            if (e.key === " " || e.code === "Space") {
                paused = !paused;
                setStatus();
                return;
            }
            if (e.key === "r" || e.key === "R") {
                restart();
                return;
            }
            const dir = directionMap[e.key];
            if (dir) {
                e.preventDefault();
                setDirection(dir);
            }
        });

        controlButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const dirKey = btn.dataset.dir;
                const map = {
                    up: { x: 0, y: -1 },
                    down: { x: 0, y: 1 },
                    left: { x: -1, y: 0 },
                    right: { x: 1, y: 0 }
                };
                setDirection(map[dirKey]);
            });
        });

        pauseBtn.addEventListener("click", () => {
            paused = !paused;
            setStatus();
        });

        restartBtn.addEventListener("click", () => {
            restart();
        });

        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                const radius = Math.min(r, w / 2, h / 2);
                this.beginPath();
                this.moveTo(x + radius, y);
                this.arcTo(x + w, y, x + w, y + h, radius);
                this.arcTo(x + w, y + h, x, y + h, radius);
                this.arcTo(x, y + h, x, y, radius);
                this.arcTo(x, y, x + w, y, radius);
                this.closePath();
                return this;
            };
        }

        const resizeObserver = new ResizeObserver(resizeBoard);
        resizeObserver.observe(boardWrapper);
        window.addEventListener("resize", resizeBoard);
        restart();
        startLoop();
    </script>
</body>

</html>
